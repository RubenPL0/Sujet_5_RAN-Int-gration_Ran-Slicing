apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "oai-gnb-slicing.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: oai-gnb-slicing
spec:
  replicas: 1
  selector:
    matchLabels:
      app: oai-gnb-slicing
  template:
    metadata:
      labels:
        app: oai-gnb-slicing
      annotations:
        {{- if .Values.multus.enabled }}
        k8s.v1.cni.cncf.io/networks: |
          [
            {{- range $i, $net := .Values.multus.networks }}
            {{- if $i }},{{ end }}
            {
              "name": "{{ $net.name }}",
              "interface": "{{ $net.interface }}",
              "ips": {{ toJson $net.ips }}
            }
            {{- end }}
          ]
        {{- end }}
    spec:
      serviceAccountName: {{ include "oai-gnb-slicing.fullname" . }}
      containers:
      - name: gnb
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        
        {{- if .Values.ranSlicing.enabled }}
        env:
        - name: RAN_SLICING_ENABLED
          value: "yes"
        - name: RAN_SLICING_POLICY
          value: "{{ .Values.ranSlicing.policyFile }}"
        {{- end }}
        
        command: ["/bin/sh", "-c"]
        args:
          - |
            # Copier les fichiers de configuration
            cp /opt/oai/config/gnb.conf /tmp/gnb.conf
            cp /opt/oai/policy/rrmPolicy.json /opt/oai/etc/rrmPolicy.json
            
            # Lancer le gNB avec RAN slicing activ√©
            /opt/oai-gnb/bin/nr-softmodem \
              -O /tmp/gnb.conf \
              --sa \
              --rfsim \
              --log_config.global_log_options level,nocolor,time
        
        ports:
        - name: ngap
          containerPort: {{ .Values.service.ports.ngap }}
          protocol: SCTP
        - name: gtp
          containerPort: {{ .Values.service.ports.gtp }}
          protocol: UDP
        
        volumeMounts:
        - name: config-volume
          mountPath: /opt/oai/config
        - name: policy-volume
          mountPath: /opt/oai/policy
        {{- if .Values.persistence.enabled }}
        - name: logs
          mountPath: {{ .Values.persistence.mountPath }}
        {{- end }}
        
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        
        securityContext:
          privileged: true
          capabilities:
            add:
            - NET_ADMIN
            - SYS_ADMIN
      
      volumes:
      - name: config-volume
        configMap:
          name: {{ .Values.configMaps.gnbConfig }}
      - name: policy-volume
        configMap:
          name: {{ .Values.configMaps.ranPolicy }}
      {{- if .Values.persistence.enabled }}
      - name: logs
        persistentVolumeClaim:
          claimName: {{ include "oai-gnb-slicing.fullname" . }}-logs
      {{- end }}
